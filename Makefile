# =============================================================================
# üöÄ LocalStack Lambda CI/CD Pipeline
# =============================================================================
# Makefile para desarrollo, testing y deployment de AWS Lambdas en LocalStack
# Incluye: auto-discovery, mock injection, security scanning, y m√°s
# =============================================================================

# =========================
# üîß Configuraci√≥n Base
# =========================
SHELL := /bin/bash
.DEFAULT_GOAL := help

# AWS Configuration
AWS_ENDPOINT ?= http://localhost:4566
REGION       ?= us-east-1

# Python & Tools
PY     := $(shell command -v python3)
PYTEST := $(shell command -v pytest)

# Terraform (local o Docker fallback)
TF_DOCKER = docker run --rm \
  -v "$(PWD)":/workspace -w /workspace \
  --network host \
  -u $$(id -u):$$(id -g) \
  -e AWS_ACCESS_KEY_ID=test \
  -e AWS_SECRET_ACCESS_KEY=test \
  -e AWS_DEFAULT_REGION=$(REGION) \
  hashicorp/terraform:1.9.5
TF := $(shell command -v terraform 2>/dev/null || echo $(TF_DOCKER))

# Auto-discovery de lambdas
LAMBDA_DIRS := $(shell find lambdas -mindepth 1 -maxdepth 1 -type d -printf "%f\n" 2>/dev/null | sort)
REQ_FILES   := $(shell find lambdas -mindepth 2 -maxdepth 2 -name requirements.txt 2>/dev/null | sort)

# Test suite selector
RUN ?= smoke
SMOKE_SINCE ?= 5
LOG_WINDOW ?= 60

# Directories
SCRIPTS_DIR := scripts
LOGS_DIR    := logs
REPORTS_DIR := reports

# =========================
# üìö Ayuda
# =========================
.PHONY: help
help: ## üìñ Muestra esta ayuda
	@echo ""
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë  üöÄ LocalStack Lambda CI/CD Pipeline                         ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@echo ""
	@echo "üìã Comandos disponibles:"
	@echo ""
	@grep -E '^[a-zA-Z0-9_.-]+:.*?##' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-24s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "üí° Ejemplos de uso:"
	@echo "  make all                  # Pipeline completo"
	@echo "  make up deploy            # Solo deploy"
	@echo "  make invoke-hello_world   # Invocar lambda espec√≠fica"
	@echo "  make logs-hello_world     # Ver logs de lambda"
	@echo ""

# =========================
# üî® Bootstrap & Setup
# =========================
.PHONY: bootstrap
bootstrap: ## üî® Instala herramientas de desarrollo
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë  üîß Instalando dependencias...                               ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@if ! command -v zip &> /dev/null; then \
		echo "‚ö†Ô∏è  'zip' no encontrado, instalando..."; \
		sudo apt-get update && sudo apt-get install -y zip || \
		(echo "‚ùå Error: No se pudo instalar 'zip'. Inst√°lalo manualmente: sudo apt install zip" && exit 1); \
	fi
	@$(PY) -m pip install --upgrade pip --quiet
	@$(PY) -m pip install -r dev-requirements.txt --quiet
	@if command -v pre-commit &> /dev/null; then pre-commit install; fi
	@echo "‚úÖ Bootstrap completo"
	@echo ""

.PHONY: ensure-dirs
ensure-dirs: ## üìÅ Crea directorios necesarios
	@mkdir -p $(LOGS_DIR) $(REPORTS_DIR)

# =========================
# üê≥ LocalStack Management
# =========================
.PHONY: up down restart status
up: ## üê≥ Levanta LocalStack
	@echo "üê≥ Iniciando LocalStack..."
	@docker compose up -d
	@echo "‚úÖ LocalStack corriendo en $(AWS_ENDPOINT)"

down: ## üõë Apaga LocalStack
	@echo "üõë Deteniendo LocalStack..."
	@docker compose down -v
	@echo "‚úÖ LocalStack detenido"

restart: down up ## üîÑ Reinicia LocalStack

status: ## üìä Estado de LocalStack
	@echo "üìä Estado de contenedores:"
	@docker compose ps

# =========================
# üßπ Limpieza
# =========================
.PHONY: clean clean-all
clean: ## üßπ Limpia archivos generados
	@echo "üßπ Limpiando archivos generados..."
	@find lambdas -name "dist.zip" -delete 2>/dev/null || true
	@find lambdas -name "mock_config.json" -delete 2>/dev/null || true
	@rm -f .lambdas_discovered.json .test_results.json
	@rm -rf $(LOGS_DIR)/* $(REPORTS_DIR)/* 2>/dev/null || true
	@if [ -d .localstack ]; then \
		if [ -w .localstack ]; then \
			rm -rf .localstack; \
		else \
			sudo rm -rf .localstack; \
		fi \
	fi
	@echo "‚úÖ Limpieza completa"

clean-all: clean down ## üßπüí£ Limpieza total (incluye LocalStack)
	@echo "‚úÖ Limpieza total completada"

# =========================
# üîç Auto-Discovery
# =========================
.PHONY: discover
discover: ## üîç Auto-descubre lambdas
	@echo "üîç Auto-descubriendo lambdas..."
	@$(PY) testing/auto_discovery.py

# =========================
# ü§ñ Mock Configuration
# =========================
.PHONY: generate-mock-configs
generate-mock-configs: discover ## ü§ñ Genera mock_config.json autom√°ticamente
	@$(PY) testing/generate_mock_configs.py

# =========================
# üì¶ Empaquetado
# =========================
.PHONY: package-% package-all
package-%: ## üì¶ Empaqueta lambda espec√≠fica (ej: package-hello_world)
	@echo "üì¶ Empaquetando lambda: $*"
	@PYTHON=$(PY) $(SCRIPTS_DIR)/package_all_lambdas.sh $*

package-all: discover ## üì¶ Empaqueta todas las lambdas
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë  üì¶ Empaquetando todas las lambdas...                        ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@PYTHON=$(PY) $(SCRIPTS_DIR)/package_all_lambdas.sh
	@echo ""
	@echo "‚úÖ Lambdas empaquetadas:"
	@for dir in $(LAMBDA_DIRS); do echo "   ‚úì $$dir"; done
	@echo ""

# =========================
# üèóÔ∏è  Terraform / Infrastructure
# =========================
.PHONY: plan deploy nuke
plan: ## üîç Terraform plan (preview de cambios)
	@echo "üîç Ejecutando terraform plan..."
	@cd infra/terraform && $(TF) init -upgrade && $(TF) plan

deploy: ## üöÄ Despliega infraestructura a LocalStack
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë  üöÄ Desplegando a LocalStack...                              ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@cd infra/terraform && $(TF) init -upgrade && $(TF) apply -auto-approve
	@echo ""
	@echo "‚úÖ Deployment completado"
	@echo ""

nuke: ## üí£ Destruye toda la infraestructura
	@echo "üí£ Destruyendo infraestructura..."
	@cd infra/terraform && $(TF) init -upgrade && $(TF) destroy -auto-approve || true
	@echo "‚úÖ Infraestructura destruida"

# =========================
# üß™ Tests Autom√°ticos
# =========================
.PHONY: test-auto
test-auto: ensure-dirs ## üß™ Tests autom√°ticos de integraci√≥n + mocks
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë  üß™ Ejecutando tests autom√°ticos...                          ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@$(PY) testing/auto_test_runner.py || true
	@echo ""
	@echo "üìã Guardando logs de lambdas..."
	@names=$$(cat .lambdas_discovered.json | jq -r '.[].name' 2>/dev/null); \
	for fn in $$names; do \
	  echo "   üìÑ $$fn..."; \
	  $(PY) $(SCRIPTS_DIR)/tail_logs.py \
	    --log-group "/aws/lambda/$$fn" \
	    --since-seconds 300 \
	    --output-file "$(LOGS_DIR)/$$fn.log" \
	    --max-bytes 2000000 \
	    --backup-count 5 2>/dev/null || echo "   ‚ö†Ô∏è  Sin logs"; \
	done
	@echo "‚úÖ Logs guardados en $(LOGS_DIR)/"
	@echo ""

# =========================
# üî• Smoke Tests
# =========================
.PHONY: list-lambdas smoke
list-lambdas: ## üìã Lista lambdas desplegadas
	@echo "üìã Lambdas desplegadas:"
	@cd infra/terraform && $(TF) output -json lambda_names 2>/dev/null | jq -r '.[]' | \
		awk '{print "   ‚úì " $$0}' || echo "   ‚ö†Ô∏è  Ejecuta 'make deploy' primero"

smoke: ensure-dirs ## üî• Smoke tests (invoca todas las lambdas)
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë  üî• Ejecutando smoke tests...                                ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@$(MAKE) --no-print-directory smoke-execute

.PHONY: smoke-execute
smoke-execute:
	@names=$$(cd infra/terraform && $(TF) output -json lambda_names 2>/dev/null | jq -r '.[]'); \
	if [ -z "$$names" ] || [ "$$names" = "null" ]; then \
	  echo "‚ö†Ô∏è  No hay output de Terraform, usando lambdas descubiertas..."; \
	  names=$$(cat .lambdas_discovered.json | jq -r '.[].name' 2>/dev/null); \
	fi; \
	for fn in $$names; do \
	  echo ""; \
	  echo "==> Invoke $$fn"; \
	  "$(PY)" "$(SCRIPTS_DIR)/invoke.py" --function "$$fn" --payload '{"name":"Smoke"}' || exit 1; \
	  echo "==> Logs $$fn (last $(LOG_WINDOW)s)"; \
	  "$(PY)" "$(SCRIPTS_DIR)/tail_logs.py" \
	    --log-group "/aws/lambda/$$fn" \
	    --since-seconds "$(LOG_WINDOW)" \
	    --output-file "$(LOGS_DIR)/$$fn.log" \
	    --max-bytes "2000000" \
	    --backup-count "5" || true; \
	done

# =========================
# üìû Invocaci√≥n Manual
# =========================
.PHONY: invoke-% invoke
invoke-%: ## üìû Invoca lambda espec√≠fica (ej: invoke-hello_world)
	@echo "üìû Invocando lambda: $*"
	@$(PY) $(SCRIPTS_DIR)/invoke.py --function $* --payload '{"name":"Manual Test"}'

invoke: ## üìû Invoca lambda custom: FN=nombre PAYLOAD='{"k":"v"}'
	@if [ -z "$(FN)" ]; then \
		echo "‚ùå Error: Especifica FN=nombre_lambda"; \
		echo "   Ejemplo: make invoke FN=hello_world PAYLOAD='{\"test\":true}'"; \
		exit 1; \
	fi
	@echo "üìû Invocando $(FN)..."
	@$(PY) $(SCRIPTS_DIR)/invoke.py --function "$(FN)" --payload '$(PAYLOAD)'

# =========================
# üìú Logs
# =========================
.PHONY: logs-% logs-follow-% logs-quick-%
logs-%: ensure-dirs ## üìú Ver logs de lambda (ej: logs-hello_world)
	@echo "üìú Obteniendo logs de $*..."
	@rm -f $(LOGS_DIR)/$*.log
	@$(PY) $(SCRIPTS_DIR)/tail_logs.py \
		--log-group /aws/lambda/$* \
		--since-seconds $(SMOKE_SINCE) \
		--output-file $(LOGS_DIR)/$*.log \
		--max-bytes 2000000 \
		--backup-count 5 || true
	@echo "‚úÖ Logs guardados en $(LOGS_DIR)/$*.log"

logs-follow-%: ensure-dirs ## üìúüîÑ Sigue logs en tiempo real (ej: logs-follow-hello_world)
	@echo "üìúüîÑ Siguiendo logs de $* en tiempo real..."
	@$(PY) $(SCRIPTS_DIR)/tail_logs.py \
		--log-group /aws/lambda/$* \
		--follow \
		--idle-exit 15 \
		--max-seconds 300 \
		--output-file $(LOGS_DIR)/$*.log || true

logs-quick-%: ensure-dirs ## üìú‚ö° Ver √∫ltimos logs (30s) (ej: logs-quick-hello_world)
	@echo "üìú‚ö° Logs r√°pidos de $*..."
	@$(PY) $(SCRIPTS_DIR)/tail_logs.py \
		--log-group /aws/lambda/$* \
		--follow \
		--since-seconds 30 \
		--idle-exit 5 \
		--max-seconds 60 \
		--output-file $(LOGS_DIR)/$*.log || true

# =========================
# üß™ Tests Tradicionales
# =========================
.PHONY: test-unit test-integration test-integration-verbose
test-unit: ## üß™ Unit tests
	@echo "üß™ Ejecutando unit tests..."
	@$(PYTEST) -q tests/unit

test-integration: ## üß™ Tests de integraci√≥n
	@echo "üß™ Ejecutando tests de integraci√≥n..."
	@$(PYTEST) -q --no-cov tests/integration

test-integration-verbose: ## üß™ Tests de integraci√≥n (verbose)
	@echo "üß™ Ejecutando tests de integraci√≥n (verbose)..."
	@$(PYTEST) -vv -s --no-cov -rA --durations=5 tests/integration

# =========================
# üéØ Suite Selector
# =========================
.PHONY: run-suite
run-suite: ## üéØ Ejecuta suite de tests (RUN=smoke|tests|all)
	@echo "üéØ Ejecutando suite: $(RUN)"
	@if [ "$(RUN)" = "tests" ]; then \
	  $(MAKE) --no-print-directory test-integration; \
	elif [ "$(RUN)" = "smoke" ]; then \
	  $(MAKE) --no-print-directory smoke; \
	else \
	  $(MAKE) --no-print-directory test-integration && $(MAKE) --no-print-directory smoke; \
	fi

# =========================
# üîí Security Scanning
# =========================
.PHONY: security-scan
security-scan: ensure-dirs ## üîí An√°lisis de seguridad (Bandit + pip-audit)
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë  üîí Ejecutando an√°lisis de seguridad...                      ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@bandit -r lambdas -f json -o $(REPORTS_DIR)/bandit_report.json --quiet || true
	@echo "" > $(REPORTS_DIR)/pip_audit_report.txt
	@for f in $(REQ_FILES); do \
	  echo "==> pip-audit $$f"; \
	  echo "=== Auditing $$f ===" >> $(REPORTS_DIR)/pip_audit_report.txt; \
	  pip-audit -r "$$f" >> $(REPORTS_DIR)/pip_audit_report.txt 2>&1 || true; \
	  echo "" >> $(REPORTS_DIR)/pip_audit_report.txt; \
	done
	@$(PY) $(SCRIPTS_DIR)/security_console_report.py || true
	@echo ""
	@echo "‚úÖ Reportes de seguridad guardados:"
	@echo "   üìÑ Bandit:       $(REPORTS_DIR)/bandit_report.json"
	@echo "   üìÑ pip-audit:    $(REPORTS_DIR)/pip_audit_report.txt"
	@echo "   üìÑ Consolidado:  $(REPORTS_DIR)/security_console_report.json"
	@echo ""

# =========================
# üöÄ Pipeline Completo
# =========================
.PHONY: all all-down all-nuke
all: ensure-dirs ## üöÄ Pipeline CI/CD completo
	@echo ""
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë  üöÄ PIPELINE CI/CD COMPLETO                                  ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@echo ""
	@$(MAKE) --no-print-directory up
	@$(MAKE) --no-print-directory discover
	@$(MAKE) --no-print-directory generate-mock-configs
	@$(MAKE) --no-print-directory package-all
	@$(MAKE) --no-print-directory deploy
	@$(MAKE) --no-print-directory list-lambdas
	@$(MAKE) --no-print-directory test-auto
	@$(MAKE) --no-print-directory run-suite
	@$(MAKE) --no-print-directory security-scan
	@echo ""
	@echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
	@echo "‚ïë  ‚úÖ PIPELINE COMPLETADO                                      ‚ïë"
	@echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
	@echo ""
	@echo "üìä Reportes generados:"
	@echo "   üîí Security:     $(REPORTS_DIR)/security_console_report.json"
	@echo "   üêõ Bandit:       $(REPORTS_DIR)/bandit_report.json"
	@echo "   üì¶ pip-audit:    $(REPORTS_DIR)/pip_audit_report.txt"
	@echo "   üß™ Tests:        .test_results.json"
	@echo "   üìú Logs:         $(LOGS_DIR)/*.log"
	@echo ""
	@echo "üí° Comandos √∫tiles:"
	@echo "   make logs-hello_world    # Ver logs de una lambda"
	@echo "   make invoke-hello_world  # Invocar una lambda"
	@echo "   make report              # Ver reporte consolidado"
	@echo ""

all-down: all ## üöÄüõë Pipeline completo + apagar LocalStack
	@$(MAKE) --no-print-directory down

all-nuke: ## üí£ Destruir todo (infra + LocalStack + archivos)
	@echo "üí£ Destruyendo todo..."
	@$(MAKE) --no-print-directory nuke
	@$(MAKE) --no-print-directory down
	@$(MAKE) --no-print-directory clean
	@echo "‚úÖ Destrucci√≥n total completada"

# =========================
# üìä Reportes
# =========================
.PHONY: report
report: ## üìä Genera reporte consolidado
	@echo "üìä Generando reporte final..."
	@$(PY) testing/report_generator.py

# =========================
# üé® Shortcuts √∫tiles
# =========================
.PHONY: dev quick
dev: up deploy ## üé® Setup r√°pido de desarrollo (up + deploy)
	@echo "‚úÖ Entorno de desarrollo listo"

quick: deploy smoke ## ‚ö° Deploy + smoke tests r√°pido
	@echo "‚úÖ Deploy y smoke tests completados"

# =========================
# EOF
# =========================
